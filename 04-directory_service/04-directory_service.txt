Lab 04 : directory service 
==========================
:author: Louis Coilliot
:numbered:
:icons:
:data-uri:
:iconsdir: /home/lofic/Documents/icons/asciidoc

Introduction
------------

We will install a LDAP directory service to provide a central source for account
information. 

The communication with the server will be encrypted using SSL/TLS.

The open source LDAP server used here is '389 Directory Server'.

This is a guided lab.

Prerequisites
-------------

[WARNING]
The DNS must provide direct and reverse resolution of the hostname of the
server.

Run `dsktune` for recommendations. But fine tuning is not mandatory for a lab.

On Centos 6 you will need to set some additional yum repositories :

* EPEL
* Continuous release (cr)
* 389-ds-base from Rich Megginson

[source, sh]
--------------------------------------------------------------------------------
rpm -Uvh http://rpmfind.net/linux/epel/6/i386/epel-release-6-7.noarch.rpm
yum -y install centos-release-cr
wget http://repos.fedorapeople.org/repos/rmeggins/389-ds-base/epel-389-ds-base.repo \
 -O /etc/yum.repos.d/epel-389-ds-base.repo 
yum clean all && yum makecache
--------------------------------------------------------------------------------

Install 389-DS
--------------

[source, sh]
--------------------------------------------------------------------------------
yum -y install 389-ds
--------------------------------------------------------------------------------

Set the Directory service
-------------------------

We will set a response file for a non interactive installation.

Get the template here :
link:https://raw.github.com/lofic/linuxlab/master/04-directory_service/resources/setup-ds-admin-full.inf[setup-ds-admin-full.inf]

Adjust the parameters to your need.

For example :

[source, sh]
--------------------------------------------------------------------------------
wget https://raw.github.com/lofic/linuxlab/master/04-directory_service/resources/setup-ds-admin-full.inf 
CDADMINPW=plokiploki;SADMINPW=plokiploki;RDNPW=plokiploki
SRVHOSTNAME=el6a.labolinux.fr
SRVIP=192.168.0.60
sed -i "s/CDADMINPW/$CDADMINPW/g" setup-ds-admin-full.inf
sed -i "s/SADMINPW/$SADMINPW/g"   setup-ds-admin-full.inf
sed -i "s/RDNPW/$RDNPW/g"         setup-ds-admin-full.inf
sed -i "s/SRVIP/$SRVIP/g"         setup-ds-admin-full.inf
sed -i "s/SRVHOSTNAME/$SRVHOSTNAME/g" setup-ds-admin-full.inf
--------------------------------------------------------------------------------

Generate the password hash for HashedRootDNPwd with `pwdhash`

The default password in the template is `plokiploki`

Then :

[source, sh]
--------------------------------------------------------------------------------
setup-ds-admin.pl -k -s -f setup-ds-admin-full.inf
--------------------------------------------------------------------------------

Enable and activate the services
--------------------------------

[source, sh]
--------------------------------------------------------------------------------
/sbin/chkconfig dirsrv on
/sbin/chkconfig dirsrv-admin on

/sbin/service dirsrv status
/sbin/service dirsrv-admin status
--------------------------------------------------------------------------------

Test the service :

[source, sh]
--------------------------------------------------------------------------------
ldapsearch -x -h localhost -p 389 -s base -b "" "objectclass=*"
--------------------------------------------------------------------------------

Setup the web applications :

[source, sh]
--------------------------------------------------------------------------------
setup-ds-dsgw

/sbin/service dirsrv-admin restart
--------------------------------------------------------------------------------

Uninstall everything
--------------------

If you made some mistakes and you want to start over, you can use :

[source, sh]
--------------------------------------------------------------------------------
# remove-ds-admin.pl -f -y
--------------------------------------------------------------------------------


Import some accounts
--------------------

[source, sh]
--------------------------------------------------------------------------------
cat<<EOF>/tmp/kermit.ldif
dn: uid=kermit,ou=People,dc=labolinux,dc=fr
givenName: Kermit
sn: The Frog
loginShell: /bin/bash
gidNumber: 1001
uidNumber: 1001
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: inetorgperson
objectClass: posixAccount
uid: kermit
gecos: Muppet addict
cn: Kermit The Frog
preferredLanguage: fr
homeDirectory: /home/kermit
userPassword: {SSHA}g0LlHcT7nwIwVE2582MoDKuDwx716BaxGPD1Lg==
EOF

LDAPSRV=localhost
LDAPPORT=389
BINDDN='cn=Directory Manager'
BINDPASSWD='plokiploki'

LDIFFILE=/tmp/kermit.ldif

ldapadd -h $LDAPSRV -p $LDAPPORT -D "$BINDDN" -w $BINDPASSWD -f $LDIFFILE
--------------------------------------------------------------------------------

And so on. You can add multiple accounts with the same ldif file.

Get some examples of accounts here :
link:https://github.com/lofic/linuxlab/tree/master/04-directory_service/resources/accounts[accounts] 

Generate the password hash for the users with `pwdhash`

Check the import with :

--------------------------------------------------------------------------------
ldapsearch -h $LDAPSRV -p $LDAPPORT -D "$BINDDN" -w $BINDPASSWD \
 -b 'ou=People,dc=labolinux,dc=fr' '(uid=*)'
--------------------------------------------------------------------------------


Configure a client
------------------

Without interaction :

[source, sh]
--------------------------------------------------------------------------------
LDAPSRV=el6a.labolinux.fr # <- change this

yum -y install authconfig pam_ldap fprintd-pam nss-pam-ldapd
authconfig --enableldap --enableldapauth --ldapserver=$LDAPSRV \
           --ldapbasedn='dc=labolinux,dc=fr' --update
authconfig --enablemkhomedir --enablelocauthorize --update
--------------------------------------------------------------------------------

With interaction :

[source, sh]
--------------------------------------------------------------------------------
authconfig-tui
--------------------------------------------------------------------------------

Check with :

[source, sh]
--------------------------------------------------------------------------------
getent passwd
getent group
--------------------------------------------------------------------------------


